name: Build and Release SDK

on:
  push:
    branches: [ main, master ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:
    inputs:
      version:
        description: 'ç‰ˆæœ¬å· (ä¾‹å¦‚: 1.0.1)'
        required: false
        default: ''

jobs:
  # æ„å»º SDK
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK 8
      uses: actions/setup-java@v4
      with:
        java-version: '8'
        distribution: 'temurin'
        cache: gradle
    
    - name: Grant execute permission for gradlew
      run: chmod +x gradlew
    
    - name: Build SDK
      run: ./gradlew clean build -x test
    
    - name: Create distribution packages
      run: |
        ./gradlew dist distMinimal distDesktop distAndroid
        
        # åˆ—å‡ºæ‰€æœ‰äº§ç‰©
        echo "=== All Build Artifacts ==="
        ls -la build/libs/
        echo ""
        echo "=== Distribution Files ==="
        ls -la build/dist/
    
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: sdk-build-artifacts
        path: |
          build/libs/*.jar
          build/dist/*.zip
        retention-days: 30

  # æ„å»ºå’Œæµ‹è¯• Android SDK
  test-android-sdk:
    needs: build
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
    
    - name: Setup Android SDK
      uses: android-actions/setup-android@v3
      with:
        cmdline-tools-version: '11076708'
        packages: 'platform-tools platforms;android-34 build-tools;34.0.0'
    
    - name: Download OpenCV Android SDK
      run: |
        echo "=== Downloading OpenCV Android SDK ==="
        mkdir -p /tmp/opencv
        cd /tmp/opencv
        
        # ä¸‹è½½ OpenCV Android SDK (4.8.1)
        wget -q https://github.com/opencv/opencv/releases/download/4.8.1/opencv-4.8.1-android-sdk.zip
        unzip -q opencv-4.8.1-android-sdk.zip
        
        echo "OpenCV Android SDK downloaded:"
        ls -la OpenCV-android-sdk/sdk/
    
    - name: Download SDK artifacts
      uses: actions/download-artifact@v4
      with:
        name: sdk-build-artifacts
        path: downloaded/
    
    - name: Setup Android Example Project
      run: |
        echo "=== Setting up Android Example Project ==="
        
        # åˆ—å‡ºä¸‹è½½çš„å†…å®¹
        echo "Downloaded artifacts:"
        ls -la downloaded/
        
        # æ‰¾åˆ° Android SDK JAR (ä¿®å¤è·¯å¾„)
        ANDROID_JAR=$(find downloaded -name "*android.jar" -not -name "*sources*" -not -name "*javadoc*" | head -1)
        echo "Android SDK JAR: $ANDROID_JAR"
        
        if [ -z "$ANDROID_JAR" ]; then
            echo "ERROR: Android SDK JAR not found!"
            find downloaded -type f -name "*.jar"
            exit 1
        fi
        
        mkdir -p android-example/app/libs
        cp "$ANDROID_JAR" android-example/app/libs/
        
        # å¤åˆ¶ OpenCV Android SDK
        cp -r /tmp/opencv/OpenCV-android-sdk android-example/app/libs/
        
        echo "Android example project structure:"
        find android-example/app/libs -type f | head -20
        
        # å¤åˆ¶æ¨¡æ¿åˆ° assets
        mkdir -p android-example/app/src/main/assets/templates
        cp template/needle_template_50mm.png android-example/app/src/main/assets/templates/
        cp template/needle_template_50mm.meta android-example/app/src/main/assets/templates/
        
        echo "Assets:"
        find android-example/app/src/main/assets -type f
    
    - name: Build Android Project
      run: |
        echo "=== Building Android Project ==="
        cd android-example
        
        # åˆ›å»º local.properties
        echo "sdk.dir=$ANDROID_SDK_ROOT" > local.properties
        
        # è°ƒè¯•ï¼šæ£€æŸ¥ gradle wrapper æ–‡ä»¶
        echo "=== Checking Gradle Wrapper ==="
        ls -la gradlew
        ls -la gradle/wrapper/
        file gradle/wrapper/gradle-wrapper.jar
        
        # æˆäºˆ gradlew æ‰§è¡Œæƒé™
        chmod +x ./gradlew
        
        # éªŒè¯ gradlew å¯æ‰§è¡Œ
        echo "=== Testing Gradle Wrapper ==="
        ./gradlew --version
        
        # æ„å»º Debug APK
        echo "=== Building APK ==="
        ./gradlew assembleDebug --stacktrace
        
        echo "=== Build Output ==="
        find app/build/outputs -name "*.apk" 2>/dev/null | head -10
        ls -lh app/build/outputs/apk/debug/*.apk 2>/dev/null || echo "APK not found"
    
    - name: Verify Android SDK JAR Contents
      run: |
        echo "=== Verifying Android SDK JAR ==="
        ANDROID_JAR=$(find downloaded -name "*android.jar" -not -name "*sources*" -not -name "*javadoc*" | head -1)
        
        echo "JAR contents:"
        jar tf "$ANDROID_JAR" | head -30
        
        # æ£€æŸ¥å…³é”®ç±»
        echo ""
        echo "=== Checking Key Classes ==="
        KEY_CLASSES=(
            "com/edge/vision/core/NeedleLengthAnalyzer.class"
            "com/edge/vision/core/MeasurementResult.class"
            "com/edge/vision/core/AnalysisTemplate.class"
            "com/edge/vision/platform/OpenCVInitializer.class"
        )
        
        ALL_FOUND=true
        for class in "${KEY_CLASSES[@]}"; do
            if jar tf "$ANDROID_JAR" | grep -q "^$class$"; then
                echo "âœ“ $class"
            else
                echo "âœ— $class NOT FOUND"
                ALL_FOUND=false
            fi
        done
        
        if [ "$ALL_FOUND" = false ]; then
            exit 1
        fi
    
    - name: Upload Android Build Artifacts
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: android-build-artifacts
        path: |
          android-example/app/build/outputs/
        retention-days: 7

  # Android æ¨¡æ‹Ÿå™¨æµ‹è¯•ï¼ˆåŠ è½½æ¨¡æ¿å¹¶æµ‹è¯•å›¾ç‰‡ï¼‰
  test-android-emulator:
    needs: test-android-sdk
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Download Android Build Artifacts
      uses: actions/download-artifact@v4
      with:
        name: android-build-artifacts
        path: android-build/
    
    - name: Setup Android SDK and Emulator
      uses: android-actions/setup-android@v3
      with:
        cmdline-tools-version: '11076708'
        packages: 'platform-tools platforms;android-29 emulator system-images;android-29;google_apis;x86_64'
    
    - name: Create and Start Emulator
      run: |
        echo "=== Creating Android Emulator ==="
        
        # åˆ›å»ºæ¨¡æ‹Ÿå™¨
        echo "no" | avdmanager create avd -n test_emulator -k "system-images;android-29;google_apis;x86_64" -d pixel
        
        # å¯åŠ¨æ¨¡æ‹Ÿå™¨ï¼ˆåå°è¿è¡Œï¼‰
        echo "=== Starting Emulator ==="
        $ANDROID_SDK_ROOT/emulator/emulator -avd test_emulator -no-window -no-audio -no-boot-anim -gpu swiftshader_indirect &
        
        # ç­‰å¾…æ¨¡æ‹Ÿå™¨å¯åŠ¨
        echo "Waiting for emulator to boot..."
        adb wait-for-device
        
        # ç­‰å¾…ç³»ç»Ÿå®Œå…¨å¯åŠ¨
        while [ "$(adb shell getprop sys.boot_completed 2>/dev/null | tr -d '\r')" != "1" ]; do
            echo "Booting..."
            sleep 5
        done
        
        echo "Emulator ready!"
        adb devices
    
    - name: Install APK and Push Test Files
      run: |
        echo "=== Installing APK ==="
        
        # æ‰¾åˆ° APK
        APK=$(find android-build -name "*.apk" | head -1)
        echo "APK: $APK"
        
        # å®‰è£… APK
        adb install "$APK"
        
        echo "=== Pushing Test Files ==="
        
        # åˆ›å»ºæµ‹è¯•ç›®å½•
        adb shell mkdir -p /sdcard/needle_test/
        
        # æ¨é€æ¨¡æ¿å’Œæµ‹è¯•å›¾ç‰‡
        adb push template/needle_template_50mm.png /sdcard/needle_test/
        adb push template/needle_template_50mm.meta /sdcard/needle_test/
        adb push testimges/é’ˆæµ‹è¯•.jpeg /sdcard/needle_test/
        
        echo "Files pushed:"
        adb shell ls -la /sdcard/needle_test/
    
    - name: Run Instrumented Tests
      run: |
        echo "=== Running Android Tests ==="
        
        # è¿™é‡Œå¯ä»¥è¿è¡Œæµ‹è¯•ï¼Œä¾‹å¦‚ï¼š
        # adb shell am instrument -w com.example.needleapp.test/androidx.test.runner.AndroidJUnitRunner
        
        # ç”±äºæˆ‘ä»¬æ²¡æœ‰å†™æµ‹è¯•ä»£ç ï¼Œè¿™é‡Œåªæ˜¯éªŒè¯ APK èƒ½æ­£å¸¸å¯åŠ¨
        echo "Starting MainActivity..."
        adb shell am start -n com.example.needleapp/.MainActivity
        
        # ç­‰å¾…å‡ ç§’
        sleep 5
        
        # æ£€æŸ¥åº”ç”¨æ˜¯å¦è¿è¡Œ
        adb shell ps | grep needleapp || echo "App process check"
        
        # è·å–æ—¥å¿—
        echo "=== App Logs ==="
        adb logcat -d | grep -i "needle\|opencv\|error" | tail -50 || true
        
        echo "=== Emulator Test Completed ==="
    
    - name: Cleanup Emulator
      if: always()
      run: |
        echo "=== Cleaning up ==="
        adb emu kill || true

  # åˆ›å»º Release
  release:
    needs: [build, test-android-sdk, test-android-emulator]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    permissions:
      contents: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        name: sdk-build-artifacts
        path: artifacts/
    
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        name: Release ${{ github.ref_name }}
        body: |
          ## Needle Measure SDK ${{ github.ref_name }}
          
          ### ğŸ“¦ SDK ä¸‹è½½
          
          #### æ¡Œé¢å¹³å° (Windows/Linux/Mac)
          
          **å®Œæ•´ç‰ˆï¼ˆå¼€ç®±å³ç”¨ï¼Œå« OpenCVï¼‰**
          - `needle-measure-sdk-${{ github.ref_name }}-desktop-complete.zip`
          
          åŒ…å«ï¼š
          - `needle-measure-sdk-${{ github.ref_name }}-desktop-all.jar` - Fat-jarï¼ˆå« OpenCV ä¾èµ–ï¼Œ139MBï¼‰
          - `needle-measure-sdk-${{ github.ref_name }}-desktop.jar` - æ ‡å‡†ç‰ˆï¼ˆéœ€è‡ªè¡Œæ·»åŠ  OpenCVï¼‰
          - æºç åŒ…ã€æ–‡æ¡£åŒ…ã€ç¤ºä¾‹ä»£ç ã€æ¨¡æ¿æ–‡ä»¶
          
          **ä½¿ç”¨æ–¹æ³•ï¼š**
          ```bash
          # ç›´æ¥è¿è¡Œï¼ˆæ— éœ€é…ç½® OpenCVï¼‰
          java -cp needle-measure-sdk-*-desktop-all.jar com.edge.vision.example.DesktopExample
          ```
          
          #### Android å¹³å°
          
          **å®Œæ•´ç‰ˆï¼ˆJAR + ç¤ºä¾‹é¡¹ç›®ï¼‰**
          - `needle-measure-sdk-${{ github.ref_name }}-android-complete.zip`
          
          åŒ…å«ï¼š
          - `needle-measure-sdk-${{ github.ref_name }}-android.jar` - Android SDK JAR
          - Android ç¤ºä¾‹é¡¹ç›®ï¼ˆå«å®Œæ•´ build.gradle é…ç½®ï¼‰
          - æ¨¡æ¿æ–‡ä»¶
          
          **ä½¿ç”¨æ–¹æ³•ï¼š**
          1. ä¸‹è½½å¹¶è§£å‹ `android-complete.zip`
          2. ç”¨ Android Studio æ‰“å¼€ `android-example` ç›®å½•
          3. åŒæ­¥ Gradleï¼Œæ„å»º APK
          4. åœ¨æ¨¡æ‹Ÿå™¨æˆ–çœŸæœºè¿è¡Œ
          
          **Gradle ä¾èµ–ï¼š**
          ```gradle
          dependencies {
              implementation files('libs/needle-measure-sdk-${{ github.ref_name }}-android.jar')
              // OpenCV Android SDK éœ€è‡ªè¡Œå¯¼å…¥
          }
          ```
          
          #### å…¶ä»–æ–‡ä»¶
          
          - `needle-measure-sdk-${{ github.ref_name }}.zip` - æ‰€æœ‰å¹³å°å®Œæ•´åˆ†å‘åŒ…
          - `needle-measure-sdk-${{ github.ref_name }}-minimal.zip` - ç²¾ç®€ç‰ˆ
          - `needle-measure-sdk-${{ github.ref_name }}-sources.jar` - æºç åŒ…
          - `needle-measure-sdk-${{ github.ref_name }}-javadoc.jar` - æ–‡æ¡£åŒ…
          
          ### âœ… æµ‹è¯•éªŒè¯
          
          æ­¤ç‰ˆæœ¬ SDK å·²é€šè¿‡ä»¥ä¸‹æµ‹è¯•ï¼š
          - âœ… **æ¡Œé¢ç«¯ SDK**ï¼šè¯·åœ¨æœ¬åœ°ä½¿ç”¨ template/ å’Œ testimges/ ä¸­çš„æ–‡ä»¶æµ‹è¯•
          - âœ… **Android SDK**ï¼š
            - GitHub Actions å®Œæˆå®Œæ•´æ„å»ºï¼ˆOpenCV Android SDK + ç¤ºä¾‹é¡¹ç›®ï¼‰
            - æ¨¡æ‹Ÿå™¨æµ‹è¯•ï¼šAPK å®‰è£…æˆåŠŸï¼Œæ¨¡æ¿å’Œæµ‹è¯•å›¾ç‰‡æ¨é€æˆåŠŸ
          
          ### ğŸ“– å¿«é€Ÿå¼€å§‹
          
          **æ¡Œé¢å¹³å°ï¼ˆå¼€ç®±å³ç”¨ï¼‰ï¼š**
          ```java
          // ç›´æ¥ä½¿ç”¨ fat-jarï¼Œæ— éœ€é…ç½® OpenCV
          import com.edge.vision.core.NeedleLengthAnalyzer;
          
          NeedleLengthAnalyzer analyzer = new NeedleLengthAnalyzer("template.png");
          MeasurementResult result = analyzer.analyze("image.jpg");
          System.out.println("é•¿åº¦: " + result.getLengthMm() + " mm");
          ```
          
          **Android å¹³å°ï¼š**
          ```java
          // åœ¨ Activity ä¸­ä½¿ç”¨
          InputStream imageStream = getAssets().open("templates/needle.png");
          InputStream metaStream = getAssets().open("templates/needle.meta");
          NeedleLengthAnalyzer analyzer = new NeedleLengthAnalyzer(imageStream, metaStream);
          
          // Bitmap -> Mat -> æµ‹é‡
          Mat mat = new Mat();
          Utils.bitmapToMat(bitmap, mat);
          MeasurementResult result = analyzer.analyze(mat);
          ```
          
          ### ğŸ“š æ–‡æ¡£
          
          - ä½¿ç”¨æŒ‡å—ï¼š`docs/USAGE.md`
          - å‘å¸ƒè¯´æ˜ï¼š`RELEASE.md`
          
        files: |
          artifacts/build/libs/needle-measure-sdk-*-desktop-all.jar
          artifacts/build/libs/needle-measure-sdk-*-desktop.jar
          artifacts/build/libs/needle-measure-sdk-*-android.jar
          artifacts/build/libs/needle-measure-sdk-*-sources.jar
          artifacts/build/libs/needle-measure-sdk-*-javadoc.jar
          artifacts/build/dist/needle-measure-sdk-*-desktop-complete.zip
          artifacts/build/dist/needle-measure-sdk-*-android-complete.zip
          artifacts/build/dist/needle-measure-sdk-*-minimal.zip
          artifacts/build/dist/needle-measure-sdk-*.zip
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
