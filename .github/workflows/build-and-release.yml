name: Build and Release

on:
  push:
    branches: [ main, master ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  # 构建和测试
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 8
      uses: actions/setup-java@v4
      with:
        java-version: '8'
        distribution: 'temurin'
        cache: gradle

    - name: Grant execute permission
      run: chmod +x gradlew

    - name: Build and Test
      run: ./gradlew build test

    - name: Build All Platforms
      run: ./gradlew buildAllPlatforms

    - name: Create Distribution Packages
      run: ./gradlew distAll

    - name: List Build Artifacts
      run: |
        echo "=== JAR Files ==="
        ls -lh build/libs/*.jar
        echo ""
        echo "=== Distribution Files ==="
        ls -lh build/dist/

    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: sdk-artifacts
        path: |
          build/libs/*.jar
          build/dist/*.zip
        retention-days: 30

  # Android 构建验证
  verify-android:
    needs: build
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Setup Android SDK
      uses: android-actions/setup-android@v3

    - name: Download SDK artifacts
      uses: actions/download-artifact@v4
      with:
        name: sdk-artifacts
        path: artifacts/

    - name: Setup Android Example
      run: |
        # 复制 Android SDK JAR
        mkdir -p android-example/app/libs
        cp artifacts/build/libs/*-android.jar android-example/app/libs/

        # 复制模板文件
        mkdir -p android-example/app/src/main/assets/templates
        cp template/needle_template_50mm.* android-example/app/src/main/assets/templates/

    - name: Build Android Example
      run: |
        cd android-example
        echo "sdk.dir=$ANDROID_SDK_ROOT" > local.properties
        chmod +x ./gradlew
        ./gradlew assembleDebug --stacktrace

    - name: Verify APK
      run: |
        echo "=== APK Output ==="
        find android-example/app/build/outputs -name "*.apk" -exec ls -lh {} \;

  # 发布 Release
  release:
    needs: [build, verify-android]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    permissions:
      contents: write

    steps:
    - name: Download artifacts
      uses: actions/download-artifact@v4
      with:
        name: sdk-artifacts
        path: artifacts/

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        name: Release ${{ github.ref_name }}
        body: |
          ## Needle Measure SDK ${{ github.ref_name }}

          ### 下载

          | 文件 | 说明 | 推荐场景 |
          |------|------|----------|
          | `*-windows-x86_64.zip` | Windows x64 | Windows 桌面应用 |
          | `*-linux-x86_64.zip` | Linux x64 | Linux 服务器/桌面 |
          | `*-macosx.zip` | macOS (Intel + Apple Silicon) | Mac 应用 |
          | `*-android.zip` | Android SDK | Android 应用 |
          | `*-all-platforms.zip` | 全平台 | 需要支持所有平台 |

          ### 瘦身说明

          - **平台特定版本** (~15MB): 只包含目标平台的原生库
          - **全平台版本** (~180MB): 包含所有平台的原生库

          ### 使用方法

          ```bash
          # 直接运行（已包含依赖）
          java -jar needle-measure-sdk-*-windows-x86_64.jar

          # 或作为依赖使用
          # Maven/Gradle 添加 javacv 依赖即可
          ```

          ### Android 集成

          ```groovy
          implementation files('libs/needle-measure-sdk-*-android.jar')
          implementation 'org.bytedeco:opencv:4.7.0-1.5.9:android-arm64'
          ```

        files: |
          artifacts/build/libs/*.jar
          artifacts/build/dist/*.zip
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
