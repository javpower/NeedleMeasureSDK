name: Build and Release SDK

on:
  push:
    branches: [ main, master ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:
    inputs:
      version:
        description: 'ç‰ˆæœ¬å· (ä¾‹å¦‚: 1.0.1)'
        required: false
        default: ''

jobs:
  # æ„å»º SDK
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK 8
      uses: actions/setup-java@v4
      with:
        java-version: '8'
        distribution: 'temurin'
        cache: gradle
    
    - name: Grant execute permission for gradlew
      run: chmod +x gradlew
    
    - name: Build SDK
      run: ./gradlew clean build -x test
    
    - name: Create distribution packages
      run: |
        ./gradlew dist distMinimal distDesktop distAndroid
        
        # åˆ—å‡ºæ‰€æœ‰äº§ç‰©
        echo "=== All Build Artifacts ==="
        ls -la build/libs/
        echo ""
        echo "=== Distribution Files ==="
        ls -la build/dist/
    
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: sdk-build-artifacts
        path: |
          build/libs/*.jar
          build/dist/*.zip
        retention-days: 30

  # æ„å»ºå’Œæµ‹è¯• Android SDK
  test-android-sdk:
    needs: build
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
    
    - name: Setup Android SDK
      uses: android-actions/setup-android@v3
      with:
        cmdline-tools-version: '11076708'
        packages: 'platform-tools platforms;android-34 build-tools;34.0.0'
    
    - name: Download OpenCV Android SDK
      run: |
        echo "=== Downloading OpenCV Android SDK ==="
        mkdir -p /tmp/opencv
        cd /tmp/opencv
        
        # ä¸‹è½½ OpenCV Android SDK (4.8.1)
        wget -q https://github.com/opencv/opencv/releases/download/4.8.1/opencv-4.8.1-android-sdk.zip
        unzip -q opencv-4.8.1-android-sdk.zip
        
        echo "OpenCV Android SDK downloaded:"
        ls -la OpenCV-android-sdk/sdk/
    
    - name: Download SDK artifacts
      uses: actions/download-artifact@v4
      with:
        name: sdk-build-artifacts
        path: build/
    
    - name: Setup Android Example Project
      run: |
        echo "=== Setting up Android Example Project ==="
        
        # æ‰¾åˆ° Android SDK JAR
        ANDROID_JAR=$(find build/build/libs -name "*android.jar" | head -1)
        echo "Android SDK JAR: $ANDROID_JAR"
        
        mkdir -p android-example/app/libs
        cp "$ANDROID_JAR" android-example/app/libs/
        
        # å¤åˆ¶ OpenCV Android SDK
        cp -r /tmp/opencv/OpenCV-android-sdk android-example/app/libs/
        
        echo "Android example project structure:"
        find android-example/app/libs -type f | head -20
        
        # å¤åˆ¶æ¨¡æ¿åˆ° assets
        mkdir -p android-example/app/src/main/assets/templates
        cp template/needle_template_50mm.png android-example/app/src/main/assets/templates/
        cp template/needle_template_50mm.meta android-example/app/src/main/assets/templates/
        
        echo "Assets:"
        find android-example/app/src/main/assets -type f
    
    - name: Build Android Project
      run: |
        echo "=== Building Android Project ==="
        cd android-example
        
        # åˆ›å»º local.properties
        echo "sdk.dir=$ANDROID_SDK_ROOT" > local.properties
        
        # æˆäºˆ gradlew æ‰§è¡Œæƒé™
        chmod +x ./gradlew || true
        
        # æ„å»º Debug APK
        ./gradlew assembleDebug --stacktrace
        
        echo "=== Build Output ==="
        find app/build/outputs -name "*.apk" -o -name "*.aar" 2>/dev/null | head -10
    
    - name: Verify Android SDK JAR Contents
      run: |
        echo "=== Verifying Android SDK JAR ==="
        ANDROID_JAR=$(find build/build/libs -name "*android.jar" | head -1)
        
        echo "JAR contents:"
        jar tf "$ANDROID_JAR" | head -30
        
        # æ£€æŸ¥å…³é”®ç±»
        echo ""
        echo "=== Checking Key Classes ==="
        KEY_CLASSES=(
            "com/edge/vision/core/NeedleLengthAnalyzer.class"
            "com/edge/vision/core/MeasurementResult.class"
            "com/edge/vision/core/AnalysisTemplate.class"
            "com/edge/vision/platform/OpenCVInitializer.class"
        )
        
        ALL_FOUND=true
        for class in "${KEY_CLASSES[@]}"; do
            if jar tf "$ANDROID_JAR" | grep -q "^$class$"; then
                echo "âœ“ $class"
            else
                echo "âœ— $class NOT FOUND"
                ALL_FOUND=false
            fi
        done
        
        if [ "$ALL_FOUND" = false ]; then
            exit 1
        fi
    
    - name: Verify Android SDK Package
      run: |
        echo "=== Verifying Android SDK Package ==="
        unzip -l build/build/dist/needle-measure-sdk-*-android-complete.zip | head -40
        
        # æ£€æŸ¥åŒ…å†…æ˜¯å¦åŒ…å«æ¨¡æ¿
        if unzip -l build/build/dist/needle-measure-sdk-*-android-complete.zip | grep -q "template"; then
            echo "âœ“ Templates included in package"
        else
            echo "âœ— Templates NOT included in package"
            exit 1
        fi
        
        echo ""
        echo "=== Android SDK Package Valid ==="
    
    - name: Upload Android Build Artifacts
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: android-build-artifacts
        path: |
          android-example/app/build/outputs/
          android-example/app/build/intermediates/aar_main_jar/
        retention-days: 7

  # åˆ›å»º Release
  release:
    needs: [build, test-android-sdk]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    permissions:
      contents: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        name: sdk-build-artifacts
        path: artifacts/
    
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        name: Release ${{ github.ref_name }}
        body: |
          ## Needle Measure SDK ${{ github.ref_name }}
          
          ### ğŸ“¦ SDK ä¸‹è½½
          
          #### æ¡Œé¢å¹³å° (Windows/Linux/Mac)
          
          **å®Œæ•´ç‰ˆï¼ˆå¼€ç®±å³ç”¨ï¼Œå« OpenCVï¼‰**
          - `needle-measure-sdk-${{ github.ref_name }}-desktop-complete.zip`
          
          åŒ…å«ï¼š
          - `needle-measure-sdk-${{ github.ref_name }}-desktop-all.jar` - Fat-jarï¼ˆå« OpenCV ä¾èµ–ï¼Œ139MBï¼‰
          - `needle-measure-sdk-${{ github.ref_name }}-desktop.jar` - æ ‡å‡†ç‰ˆï¼ˆéœ€è‡ªè¡Œæ·»åŠ  OpenCVï¼‰
          - æºç åŒ…ã€æ–‡æ¡£åŒ…ã€ç¤ºä¾‹ä»£ç ã€æ¨¡æ¿æ–‡ä»¶
          
          **ä½¿ç”¨æ–¹æ³•ï¼š**
          ```bash
          # ç›´æ¥è¿è¡Œï¼ˆæ— éœ€é…ç½® OpenCVï¼‰
          java -cp needle-measure-sdk-*-desktop-all.jar com.edge.vision.example.DesktopExample
          ```
          
          #### Android å¹³å°
          
          **å®Œæ•´ç‰ˆï¼ˆJAR + ç¤ºä¾‹é¡¹ç›®ï¼‰**
          - `needle-measure-sdk-${{ github.ref_name }}-android-complete.zip`
          
          åŒ…å«ï¼š
          - `needle-measure-sdk-${{ github.ref_name }}-android.jar` - Android SDK JAR
          - Android ç¤ºä¾‹é¡¹ç›®ï¼ˆå«å®Œæ•´ build.gradle é…ç½®ï¼‰
          - æ¨¡æ¿æ–‡ä»¶
          
          **ä½¿ç”¨æ–¹æ³•ï¼š**
          1. ä¸‹è½½å¹¶è§£å‹ `android-complete.zip`
          2. ç”¨ Android Studio æ‰“å¼€ `android-example` ç›®å½•
          3. åŒæ­¥ Gradleï¼Œæ„å»º APK
          4. åœ¨æ¨¡æ‹Ÿå™¨æˆ–çœŸæœºè¿è¡Œ
          
          **Gradle ä¾èµ–ï¼š**
          ```gradle
          dependencies {
              implementation files('libs/needle-measure-sdk-${{ github.ref_name }}-android.jar')
              // OpenCV Android SDK éœ€è‡ªè¡Œå¯¼å…¥
          }
          ```
          
          #### å…¶ä»–æ–‡ä»¶
          
          - `needle-measure-sdk-${{ github.ref_name }}.zip` - æ‰€æœ‰å¹³å°å®Œæ•´åˆ†å‘åŒ…
          - `needle-measure-sdk-${{ github.ref_name }}-minimal.zip` - ç²¾ç®€ç‰ˆ
          - `needle-measure-sdk-${{ github.ref_name }}-sources.jar` - æºç åŒ…
          - `needle-measure-sdk-${{ github.ref_name }}-javadoc.jar` - æ–‡æ¡£åŒ…
          
          ### âœ… æµ‹è¯•éªŒè¯
          
          æ­¤ç‰ˆæœ¬ SDK å·²é€šè¿‡ä»¥ä¸‹æµ‹è¯•ï¼š
          - âœ… **æ¡Œé¢ç«¯ SDK**ï¼šè¯·åœ¨æœ¬åœ°ä½¿ç”¨ template/ å’Œ testimges/ ä¸­çš„æ–‡ä»¶æµ‹è¯•
          - âœ… **Android SDK**ï¼šGitHub Actions å®Œæˆå®Œæ•´æ„å»ºï¼ˆOpenCV Android SDK + ç¤ºä¾‹é¡¹ç›®ï¼‰
          
          ### ğŸ“– å¿«é€Ÿå¼€å§‹
          
          **æ¡Œé¢å¹³å°ï¼ˆå¼€ç®±å³ç”¨ï¼‰ï¼š**
          ```java
          // ç›´æ¥ä½¿ç”¨ fat-jarï¼Œæ— éœ€é…ç½® OpenCV
          import com.edge.vision.core.NeedleLengthAnalyzer;
          
          NeedleLengthAnalyzer analyzer = new NeedleLengthAnalyzer("template.png");
          MeasurementResult result = analyzer.analyze("image.jpg");
          System.out.println("é•¿åº¦: " + result.getLengthMm() + " mm");
          ```
          
          **Android å¹³å°ï¼š**
          ```java
          // åœ¨ Activity ä¸­ä½¿ç”¨
          InputStream imageStream = getAssets().open("templates/needle.png");
          InputStream metaStream = getAssets().open("templates/needle.meta");
          NeedleLengthAnalyzer analyzer = new NeedleLengthAnalyzer(imageStream, metaStream);
          
          // Bitmap -> Mat -> æµ‹é‡
          Mat mat = new Mat();
          Utils.bitmapToMat(bitmap, mat);
          MeasurementResult result = analyzer.analyze(mat);
          ```
          
          ### ğŸ“š æ–‡æ¡£
          
          - ä½¿ç”¨æŒ‡å—ï¼š`docs/USAGE.md`
          - å‘å¸ƒè¯´æ˜ï¼š`RELEASE.md`
          
        files: |
          artifacts/build/libs/needle-measure-sdk-*-desktop-all.jar
          artifacts/build/libs/needle-measure-sdk-*-desktop.jar
          artifacts/build/libs/needle-measure-sdk-*-android.jar
          artifacts/build/libs/needle-measure-sdk-*-sources.jar
          artifacts/build/libs/needle-measure-sdk-*-javadoc.jar
          artifacts/build/dist/needle-measure-sdk-*-desktop-complete.zip
          artifacts/build/dist/needle-measure-sdk-*-android-complete.zip
          artifacts/build/dist/needle-measure-sdk-*-minimal.zip
          artifacts/build/dist/needle-measure-sdk-*.zip
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
