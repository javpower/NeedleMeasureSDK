name: Build and Release SDK

on:
  push:
    branches: [ main, master ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:
    inputs:
      version:
        description: 'ç‰ˆæœ¬å· (ä¾‹å¦‚: 1.0.1)'
        required: false
        default: ''

jobs:
  # æ„å»º SDK
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK 8
      uses: actions/setup-java@v4
      with:
        java-version: '8'
        distribution: 'temurin'
        cache: gradle
    
    - name: Grant execute permission for gradlew
      run: chmod +x gradlew
    
    - name: Build SDK
      run: ./gradlew clean build -x test
    
    - name: Create fat-jar (Desktop)
      run: ./gradlew desktopFatJar
    
    - name: Create distribution packages
      run: |
        ./gradlew dist distMinimal distDesktop distAndroid
        
        # åˆ—å‡ºæ‰€æœ‰äº§ç‰©
        echo "=== All Build Artifacts ==="
        ls -la build/libs/
        echo ""
        echo "=== Distribution Files ==="
        ls -la build/dist/
    
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: sdk-build-artifacts
        path: |
          build/libs/*.jar
          build/dist/*.zip
        retention-days: 30

  # æµ‹è¯•æ¡Œé¢ç«¯ SDK
  test-desktop-sdk:
    needs: build
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Download SDK artifacts
      uses: actions/download-artifact@v4
      with:
        name: sdk-build-artifacts
        path: build/
    
    - name: Set up JDK 8
      uses: actions/setup-java@v4
      with:
        java-version: '8'
        distribution: 'temurin'
    
    - name: Test Desktop SDK with template and images
      run: |
        echo "=== Testing Desktop SDK with real template and images ==="
        
        # æ‰¾åˆ° fat-jar
        SDK_JAR=$(find build/build/libs -name "*desktop-all.jar" | head -1)
        echo "SDK JAR: $SDK_JAR"
        
        # åˆ—å‡ºæ¨¡æ¿å’Œæµ‹è¯•å›¾ç‰‡
        echo "=== Template Files ==="
        ls -la template/
        
        echo "=== Test Images ==="
        ls -la testimges/
        
        # åˆ›å»ºæµ‹è¯• Java ç¨‹åº
        cat > TestSDK.java << 'TESTEOF'
        import com.edge.vision.core.NeedleLengthAnalyzer;
        import com.edge.vision.core.MeasurementResult;
        import org.opencv.core.Mat;
        import org.opencv.imgcodecs.Imgcodecs;
        import nu.pattern.OpenCV;
        
        public class TestSDK {
            static {
                OpenCV.loadLocally();
            }
            
            public static void main(String[] args) {
                try {
                    System.out.println("=== Desktop SDK Test Started ===");
                    
                    if (args.length < 2) {
                        System.err.println("Usage: java TestSDK <template.png> <test_image.jpg>");
                        System.exit(1);
                    }
                    
                    String templatePath = args[0];
                    String imagePath = args[1];
                    
                    System.out.println("Template: " + templatePath);
                    System.out.println("Test Image: " + imagePath);
                    
                    // æµ‹è¯• 1: åŠ è½½æ¨¡æ¿
                    System.out.println("\n[TEST 1] Loading template...");
                    NeedleLengthAnalyzer analyzer = new NeedleLengthAnalyzer(templatePath);
                    System.out.println("âœ“ Template loaded successfully");
                    System.out.println("  Template ID: " + analyzer.getTemplate().getTemplateId());
                    System.out.println("  Reference Length: " + analyzer.getTemplate().getReferenceLengthMm() + " mm");
                    
                    // æµ‹è¯• 2: æµ‹é‡å›¾åƒ
                    System.out.println("\n[TEST 2] Analyzing image...");
                    Mat image = Imgcodecs.imread(imagePath);
                    if (image.empty()) {
                        System.err.println("âœ— Failed to load image: " + imagePath);
                        System.exit(1);
                    }
                    System.out.println("âœ“ Image loaded: " + image.cols() + "x" + image.rows());
                    
                    MeasurementResult result = analyzer.analyze(image);
                    System.out.println("âœ“ Analysis completed");
                    
                    // æµ‹è¯• 3: è¾“å‡ºç»“æœ
                    System.out.println("\n[TEST 3] Results:");
                    System.out.println("  Length: " + result.getLengthMm() + " mm");
                    System.out.println("  Confidence: " + (result.getConfidence() * 100) + "%");
                    System.out.println("  Processing Time: " + result.getProcessingTimeMs() + " ms");
                    
                    // æµ‹è¯• 4: JSON è¾“å‡º
                    System.out.println("\n[TEST 4] JSON Output:");
                    System.out.println(result.toJsonString());
                    
                    // æµ‹è¯• 5: å¯è§†åŒ–
                    System.out.println("\n[TEST 5] Generating visualization...");
                    Mat visualization = analyzer.generateVisualization(image, result);
                    String outputPath = "/tmp/test_result.png";
                    Imgcodecs.imwrite(outputPath, visualization);
                    System.out.println("âœ“ Visualization saved: " + outputPath);
                    
                    // æ¸…ç†
                    image.release();
                    visualization.release();
                    analyzer.close();
                    
                    // éªŒè¯ç»“æœåˆç†æ€§
                    double length = result.getLengthMm();
                    double confidence = result.getConfidence();
                    
                    if (length < 40 || length > 60) {
                        System.err.println("âœ— Length out of expected range (40-60mm): " + length);
                        System.exit(1);
                    }
                    
                    if (confidence < 0.5) {
                        System.err.println("âœ— Confidence too low: " + confidence);
                        System.exit(1);
                    }
                    
                    System.out.println("\n=== All Desktop SDK Tests Passed ===");
                    System.exit(0);
                    
                } catch (Exception e) {
                    System.err.println("âœ— Test failed: " + e.getMessage());
                    e.printStackTrace();
                    System.exit(1);
                }
            }
        }
        TESTEOF
        
        # ç¼–è¯‘æµ‹è¯•ç¨‹åº
        echo "=== Compiling Test Program ==="
        javac -cp "$SDK_JAR" TestSDK.java
        
        # è¿è¡Œæµ‹è¯•ï¼ˆä½¿ç”¨æ‰€æœ‰æµ‹è¯•å›¾ç‰‡ï¼‰
        echo "=== Running Tests ==="
        TEST_FAILED=0
        
        for img in testimges/*.jpeg; do
            echo ""
            echo "Testing with: $img"
            if java -cp ".:$SDK_JAR" TestSDK template/needle_template_50mm.png "$img"; then
                echo "âœ“ PASSED: $img"
            else
                echo "âœ— FAILED: $img"
                TEST_FAILED=1
            fi
            echo "---"
        done
        
        if [ $TEST_FAILED -eq 1 ]; then
            echo "Some tests failed!"
            exit 1
        fi
        
        echo "=== Desktop SDK Test Completed Successfully ==="
    
    - name: Verify Desktop SDK package contents
      run: |
        echo "=== Verifying Desktop SDK Package ==="
        unzip -l build/build/dist/needle-measure-sdk-*-desktop-complete.zip | head -40

  # æ„å»ºå’Œæµ‹è¯• Android SDK
  test-android-sdk:
    needs: build
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
    
    - name: Setup Android SDK
      uses: android-actions/setup-android@v3
      with:
        cmdline-tools-version: '11076708'
        packages: 'platform-tools platforms;android-34 build-tools;34.0.0'
    
    - name: Download OpenCV Android SDK
      run: |
        echo "=== Downloading OpenCV Android SDK ==="
        mkdir -p /tmp/opencv
        cd /tmp/opencv
        
        # ä¸‹è½½ OpenCV Android SDK (4.8.1)
        wget -q https://github.com/opencv/opencv/releases/download/4.8.1/opencv-4.8.1-android-sdk.zip
        unzip -q opencv-4.8.1-android-sdk.zip
        
        echo "OpenCV Android SDK downloaded:"
        ls -la OpenCV-android-sdk/sdk/
    
    - name: Download SDK artifacts
      uses: actions/download-artifact@v4
      with:
        name: sdk-build-artifacts
        path: build/
    
    - name: Setup Android Example Project
      run: |
        echo "=== Setting up Android Example Project ==="
        
        # å¤åˆ¶ Android SDK JAR åˆ°ç¤ºä¾‹é¡¹ç›®
        ANDROID_JAR=$(find build/build/libs -name "*android.jar" | head -1)
        echo "Android SDK JAR: $ANDROID_JAR"
        
        mkdir -p android-example/app/libs
        cp "$ANDROID_JAR" android-example/app/libs/
        
        # å¤åˆ¶ OpenCV Android SDK
        cp -r /tmp/opencv/OpenCV-android-sdk android-example/app/libs/
        
        echo "Android example project structure:"
        find android-example/app/libs -type f | head -20
        
        # å¤åˆ¶æ¨¡æ¿åˆ° assets
        mkdir -p android-example/app/src/main/assets/templates
        cp template/needle_template_50mm.png android-example/app/src/main/assets/templates/
        cp template/needle_template_50mm.meta android-example/app/src/main/assets/templates/
        
        echo "Assets:"
        find android-example/app/src/main/assets -type f
    
    - name: Build Android Project
      run: |
        echo "=== Building Android Project ==="
        cd android-example
        
        # åˆ›å»º local.properties
        echo "sdk.dir=$ANDROID_SDK_ROOT" > local.properties
        
        # æˆäºˆ gradlew æ‰§è¡Œæƒé™
        chmod +x ./gradlew || true
        
        # æ„å»º Debug APK
        ./gradlew assembleDebug --stacktrace
        
        echo "=== Build Output ==="
        find app/build/outputs -name "*.apk" -o -name "*.aar" 2>/dev/null | head -10
    
    - name: Verify Android SDK JAR Contents
      run: |
        echo "=== Verifying Android SDK JAR ==="
        ANDROID_JAR=$(find build/build/libs -name "*android.jar" | head -1)
        
        echo "JAR contents:"
        jar tf "$ANDROID_JAR" | head -30
        
        # æ£€æŸ¥å…³é”®ç±»
        echo ""
        echo "=== Checking Key Classes ==="
        KEY_CLASSES=(
            "com/edge/vision/core/NeedleLengthAnalyzer.class"
            "com/edge/vision/core/MeasurementResult.class"
            "com/edge/vision/core/AnalysisTemplate.class"
            "com/edge/vision/platform/OpenCVInitializer.class"
        )
        
        ALL_FOUND=true
        for class in "${KEY_CLASSES[@]}"; do
            if jar tf "$ANDROID_JAR" | grep -q "^$class$"; then
                echo "âœ“ $class"
            else
                echo "âœ— $class NOT FOUND"
                ALL_FOUND=false
            fi
        done
        
        if [ "$ALL_FOUND" = false ]; then
            exit 1
        fi
    
    - name: Verify Android SDK Package
      run: |
        echo "=== Verifying Android SDK Package ==="
        unzip -l build/build/dist/needle-measure-sdk-*-android-complete.zip | head -40
        
        # æ£€æŸ¥åŒ…å†…æ˜¯å¦åŒ…å«æ¨¡æ¿
        if unzip -l build/build/dist/needle-measure-sdk-*-android-complete.zip | grep -q "template"; then
            echo "âœ“ Templates included in package"
        else
            echo "âœ— Templates NOT included in package"
            exit 1
        fi
        
        echo ""
        echo "=== Android SDK Package Valid ==="
    
    - name: Upload Android Build Artifacts
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: android-build-artifacts
        path: |
          android-example/app/build/outputs/
          android-example/app/build/intermediates/aar_main_jar/
        retention-days: 7

  # å¤šå¹³å°æ„å»ºå’Œæµ‹è¯•
  build-multi-platform:
    needs: build
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
    runs-on: ${{ matrix.os }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK 8
      uses: actions/setup-java@v4
      with:
        java-version: '8'
        distribution: 'temurin'
        cache: gradle
    
    - name: Grant execute permission for gradlew (Unix)
      if: runner.os != 'Windows'
      run: chmod +x gradlew
    
    - name: Build SDK on ${{ matrix.os }}
      run: ./gradlew clean build desktopFatJar -x test
    
    - name: Test SDK on ${{ matrix.os }}
      shell: bash
      run: |
        echo "Verifying SDK build on ${{ matrix.os }}"
        
        # æ‰¾åˆ° fat-jar
        if [[ "${{ matrix.os }}" == "windows-latest" ]]; then
          SDK_JAR=$(find build/libs -name "*desktop-all.jar" 2>/dev/null | head -1)
        else
          SDK_JAR=$(find build/libs -name "*desktop-all.jar" | head -1)
        fi
        
        if [ -n "$SDK_JAR" ] && [ -f "$SDK_JAR" ]; then
            echo "âœ“ Desktop fat-jar found: $SDK_JAR"
            ls -lh "$SDK_JAR"
        else
            echo "âœ— Desktop fat-jar NOT found"
            ls -la build/libs/
            exit 1
        fi

  # åˆ›å»º Release
  release:
    needs: [build, test-desktop-sdk, test-android-sdk, build-multi-platform]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    permissions:
      contents: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        name: sdk-build-artifacts
        path: artifacts/
    
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        name: Release ${{ github.ref_name }}
        body: |
          ## Needle Measure SDK ${{ github.ref_name }}
          
          ### ğŸ“¦ å¼€ç®±å³ç”¨ SDK ä¸‹è½½
          
          #### æ¡Œé¢å¹³å° (Windows/Linux/Mac)
          
          **æ¨èï¼šå®Œæ•´ç‰ˆï¼ˆå¼€ç®±å³ç”¨ï¼Œå« OpenCVï¼‰**
          - `needle-measure-sdk-${{ github.ref_name }}-desktop-complete.zip`
          
          åŒ…å«ï¼š
          - `needle-measure-sdk-${{ github.ref_name }}-desktop-all.jar` - Fat-jarï¼ˆå« OpenCV ä¾èµ–ï¼Œ139MBï¼‰
          - `needle-measure-sdk-${{ github.ref_name }}-desktop.jar` - æ ‡å‡†ç‰ˆï¼ˆéœ€è‡ªè¡Œæ·»åŠ  OpenCVï¼‰
          - æºç åŒ…ã€æ–‡æ¡£åŒ…
          - ç¤ºä¾‹ä»£ç ã€æ¨¡æ¿æ–‡ä»¶
          
          **ä½¿ç”¨æ–¹æ³•ï¼š**
          ```bash
          # ç›´æ¥è¿è¡Œï¼ˆæ— éœ€é…ç½® OpenCVï¼‰
          java -cp needle-measure-sdk-*-desktop-all.jar com.edge.vision.example.DesktopExample
          ```
          
          #### Android å¹³å°
          
          **å®Œæ•´ç‰ˆï¼ˆJAR + ç¤ºä¾‹é¡¹ç›®ï¼‰**
          - `needle-measure-sdk-${{ github.ref_name }}-android-complete.zip`
          
          åŒ…å«ï¼š
          - `needle-measure-sdk-${{ github.ref_name }}-android.jar` - Android SDK JAR
          - Android ç¤ºä¾‹é¡¹ç›®ï¼ˆå«å®Œæ•´ build.gradle é…ç½®ï¼‰
          - æ¨¡æ¿æ–‡ä»¶
          
          **ä½¿ç”¨æ–¹æ³•ï¼š**
          1. ä¸‹è½½å¹¶è§£å‹ `android-complete.zip`
          2. ç”¨ Android Studio æ‰“å¼€ `android-example` ç›®å½•
          3. åŒæ­¥ Gradleï¼Œæ„å»º APK
          4. åœ¨æ¨¡æ‹Ÿå™¨æˆ–çœŸæœºè¿è¡Œ
          
          **Gradle ä¾èµ–ï¼š**
          ```gradle
          dependencies {
              implementation files('libs/needle-measure-sdk-${{ github.ref_name }}-android.jar')
              // OpenCV Android SDK éœ€è‡ªè¡Œå¯¼å…¥
          }
          ```
          
          #### æ‰€æœ‰å¹³å°é€šç”¨
          
          - `needle-measure-sdk-${{ github.ref_name }}.zip` - å®Œæ•´åˆ†å‘åŒ…
          - `needle-measure-sdk-${{ github.ref_name }}-minimal.zip` - ç²¾ç®€ç‰ˆ
          
          #### å¼€å‘ä¾èµ–
          
          - `needle-measure-sdk-${{ github.ref_name }}-sources.jar` - æºç åŒ…
          - `needle-measure-sdk-${{ github.ref_name }}-javadoc.jar` - æ–‡æ¡£åŒ…
          
          ### âœ… æµ‹è¯•éªŒè¯
          
          æ­¤ç‰ˆæœ¬ SDK å·²é€šè¿‡ä»¥ä¸‹æµ‹è¯•ï¼š
          - âœ… æ¡Œé¢ç«¯ SDK ä½¿ç”¨çœŸå®æ¨¡æ¿æ–‡ä»¶æµ‹è¯•
          - âœ… æ¡Œé¢ç«¯ SDK ä½¿ç”¨ 5+ å¼ æµ‹è¯•å›¾åƒéªŒè¯
          - âœ… Android SDK å®Œæ•´æ„å»ºï¼ˆOpenCV Android SDK + ç¤ºä¾‹é¡¹ç›®ï¼‰
          - âœ… å¤šå¹³å°æ„å»ºï¼ˆUbuntu/Windows/macOSï¼‰
          
          ### ğŸ“– å¿«é€Ÿå¼€å§‹
          
          **æ¡Œé¢å¹³å°ï¼ˆå¼€ç®±å³ç”¨ï¼‰ï¼š**
          ```java
          // ç›´æ¥ä½¿ç”¨ fat-jarï¼Œæ— éœ€é…ç½® OpenCV
          import com.edge.vision.core.NeedleLengthAnalyzer;
          
          NeedleLengthAnalyzer analyzer = new NeedleLengthAnalyzer("template.png");
          MeasurementResult result = analyzer.analyze("image.jpg");
          System.out.println("é•¿åº¦: " + result.getLengthMm() + " mm");
          ```
          
          **Android å¹³å°ï¼š**
          ```java
          // åœ¨ Activity ä¸­ä½¿ç”¨
          InputStream imageStream = getAssets().open("templates/needle.png");
          InputStream metaStream = getAssets().open("templates/needle.meta");
          NeedleLengthAnalyzer analyzer = new NeedleLengthAnalyzer(imageStream, metaStream);
          
          // Bitmap -> Mat -> æµ‹é‡
          Mat mat = new Mat();
          Utils.bitmapToMat(bitmap, mat);
          MeasurementResult result = analyzer.analyze(mat);
          ```
          
          ### ğŸ“š æ–‡æ¡£
          
          - ä½¿ç”¨æŒ‡å—ï¼š`docs/USAGE.md`
          - å‘å¸ƒè¯´æ˜ï¼š`RELEASE.md`
          
        files: |
          artifacts/build/libs/needle-measure-sdk-*-desktop-all.jar
          artifacts/build/libs/needle-measure-sdk-*-desktop.jar
          artifacts/build/libs/needle-measure-sdk-*-android.jar
          artifacts/build/libs/needle-measure-sdk-*-sources.jar
          artifacts/build/libs/needle-measure-sdk-*-javadoc.jar
          artifacts/build/dist/needle-measure-sdk-*-desktop-complete.zip
          artifacts/build/dist/needle-measure-sdk-*-android-complete.zip
          artifacts/build/dist/needle-measure-sdk-*-minimal.zip
          artifacts/build/dist/needle-measure-sdk-*.zip
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
