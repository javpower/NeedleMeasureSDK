name: Build and Release SDK

on:
  push:
    branches: [ main, master ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  # æ„å»º SDK
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK 8
      uses: actions/setup-java@v4
      with:
        java-version: '8'
        distribution: 'temurin'
        cache: gradle
    
    - name: Grant execute permission for gradlew
      run: chmod +x gradlew
    
    - name: Build SDK
      run: ./gradlew clean build -x test
    
    - name: Create distribution packages
      run: |
        ./gradlew dist distMinimal distDesktop distAndroid
        
        echo "=== Build Artifacts ==="
        ls -la build/libs/
        echo ""
        echo "=== Distribution Files ==="
        ls -la build/dist/
    
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: sdk-build-artifacts
        path: |
          build/libs/*.jar
          build/dist/*.zip
        retention-days: 30

  # Android SDK æ„å»ºæµ‹è¯•ï¼ˆä½¿ç”¨ JavaCVï¼‰
  test-android-sdk:
    needs: build
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
    
    - name: Setup Android SDK
      uses: android-actions/setup-android@v3
      with:
        cmdline-tools-version: '11076708'
        packages: 'platform-tools platforms;android-34 build-tools;34.0.0'
    
    - name: Download SDK artifacts
      uses: actions/download-artifact@v4
      with:
        name: sdk-build-artifacts
        path: downloaded/
    
    - name: Setup Android Example Project
      run: |
        echo "=== Setting up Android Example Project ==="
        
        # æ‰¾åˆ° Android SDK JAR
        ANDROID_JAR=$(find downloaded -name "*android.jar" -not -name "*sources*" -not -name "*javadoc*" | head -1)
        echo "Android SDK JAR: $ANDROID_JAR"
        
        if [ -z "$ANDROID_JAR" ]; then
            echo "ERROR: Android SDK JAR not found!"
            find downloaded -type f -name "*.jar"
            exit 1
        fi
        
        mkdir -p android-example/app/libs
        cp "$ANDROID_JAR" android-example/app/libs/
        
        # å¤åˆ¶æ¨¡æ¿åˆ° assets
        mkdir -p android-example/app/src/main/assets/templates
        cp template/needle_template_50mm.png android-example/app/src/main/assets/templates/
        cp template/needle_template_50mm.meta android-example/app/src/main/assets/templates/
        
        echo "Setup complete!"
    
    - name: Build Android Project
      run: |
        echo "=== Building Android Project with JavaCV ==="
        cd android-example
        
        # åˆ›å»º local.properties
        echo "sdk.dir=$ANDROID_SDK_ROOT" > local.properties
        
        # æˆäºˆ gradlew æ‰§è¡Œæƒé™
        chmod +x ./gradlew
        
        # æ„å»º Debug APKï¼ˆJavaCV ä» Maven Central è‡ªåŠ¨ä¸‹è½½ï¼‰
        ./gradlew assembleDebug --stacktrace
        
        echo "=== Build Output ==="
        find app/build/outputs -name "*.apk" | head -10
        ls -lh app/build/outputs/apk/debug/*.apk || echo "APK not found"
    
    - name: Verify Android SDK
      run: |
        echo "=== Verifying Android SDK JAR ==="
        ANDROID_JAR=$(find downloaded -name "*android.jar" -not -name "*sources*" -not -name "*javadoc*" | head -1)
        
        echo "Checking key classes:"
        jar tf "$ANDROID_JAR" | grep -E "(NeedleLengthAnalyzer|MeasurementResult)" | head -5

  # åˆ›å»º Release
  release:
    needs: [build, test-android-sdk]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    permissions:
      contents: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        name: sdk-build-artifacts
        path: artifacts/
    
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        name: Release ${{ github.ref_name }}
        body: |
          ## Needle Measure SDK ${{ github.ref_name }}
          
          ### ğŸ“¦ SDK ä¸‹è½½
          
          #### æ¡Œé¢å¹³å° (Windows/Linux/Mac)
          
          **å¼€ç®±å³ç”¨ç‰ˆ**
          - `needle-measure-sdk-${{ github.ref_name }}-desktop-complete.zip`
          
          åŒ…å«ï¼š
          - `needle-measure-sdk-${{ github.ref_name }}-desktop-all.jar` - Fat-jarï¼ˆå« JavaCV æ‰€æœ‰å¹³å°ï¼‰
          - `needle-measure-sdk-${{ github.ref_name }}-desktop.jar` - æ ‡å‡†ç‰ˆï¼ˆé…åˆ JavaCV ä½¿ç”¨ï¼‰
          
          **ä½¿ç”¨æ–¹æ³•ï¼š**
          ```bash
          # Fat-jar ç›´æ¥è¿è¡Œ
          java -cp needle-measure-sdk-*-desktop-all.jar com.edge.vision.example.DesktopExample
          
          # æˆ–è€…é…åˆ JavaCV ä½¿ç”¨
          java -cp "needle-measure-sdk-*-desktop.jar:javacv-platform-1.5.9.jar" YourApp
          ```
          
          #### Android å¹³å°
          
          **JavaCV ç‰ˆæœ¬**
          - `needle-measure-sdk-${{ github.ref_name }}-android-complete.zip`
          
          åŒ…å«ï¼š
          - SDK JARï¼ˆå·²éªŒè¯å¯æ„å»ºï¼‰
          - å®Œæ•´ç¤ºä¾‹é¡¹ç›®ï¼ˆä½¿ç”¨ JavaCVï¼‰
          - æ¨¡æ¿æ–‡ä»¶
          
          **Gradle ä¾èµ–ï¼š**
          ```gradle
          dependencies {
              implementation files('libs/needle-measure-sdk-1.0.0-android.jar')
              
              // JavaCV for Android
              implementation 'org.bytedeco:javacv:1.5.9'
              implementation 'org.bytedeco:opencv:4.7.0-1.5.9:android-arm64'
          }
          ```
          
          ### âœ… æµ‹è¯•éªŒè¯
          - âœ… æ¡Œé¢ç«¯ SDKï¼šæœ¬åœ°æµ‹è¯•ï¼ˆJavaCVï¼‰
          - âœ… Android SDKï¼šGitHub Actions è‡ªåŠ¨æ„å»ºï¼ˆJavaCVï¼‰
          
        files: |
          artifacts/build/libs/*.jar
          artifacts/build/dist/*.zip
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
